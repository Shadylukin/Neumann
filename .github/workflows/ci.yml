---
name: CI

"on":
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      typescript: ${{ steps.filter.outputs.typescript }}
      python: ${{ steps.filter.outputs.python }}
      rust: ${{ steps.filter.outputs.rust }}
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Filter paths
        # v3.0.2
        uses: >-
          dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          filters: |
            typescript:
              - 'neumann-ts/**'
            python:
              - 'neumann-py/**'
            rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - 'Cargo.lock'

  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  check:
    name: Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable

      - name: Cache Rust
        # v2.7.8
        uses: >-
          Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6

      - name: Install protoc
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y protobuf-compiler

      - name: Run cargo check
        run: >-
          cargo check --workspace
          --exclude fuzz
          --exclude neumann-native
          --all-features

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable
          components: clippy

      - name: Cache Rust
        # v2.7.8
        uses: >-
          Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6

      - name: Install protoc
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y protobuf-compiler

      - name: Run clippy
        run: >-
          cargo clippy --workspace
          --exclude fuzz
          --exclude neumann-native
          --all-features
          -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable

      - name: Cache Rust
        # v2.7.8
        uses: >-
          Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6

      - name: Install protoc
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y protobuf-compiler

      - name: Run tests
        run: >-
          cargo test --workspace
          --exclude fuzz
          --exclude neumann-native
          --all-features

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Cache Rust
        # v2.7.8
        uses: >-
          Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6

      - name: Install protoc
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y protobuf-compiler

      - name: Install cargo-llvm-cov
        # v2.52.4
        uses: >-
          taiki-e/install-action@735e5933943122c5ac182670a935f54a949265c1
        with:
          tool: cargo-llvm-cov

      - name: Clean coverage artifacts
        run: cargo llvm-cov clean --workspace

      - name: Generate and verify coverage (95% threshold)
        run: |
          cargo llvm-cov --workspace \
            --exclude fuzz \
            --exclude neumann-native \
            --exclude integration_tests \
            --exclude stress_tests \
            --exclude examples \
            --exclude neumann_docs \
            --all-features \
            --fail-under-lines 95 \
            --html --output-dir target/llvm-cov/html

      - name: Generate codecov report
        run: |
          cargo llvm-cov --workspace \
            --exclude fuzz \
            --exclude neumann-native \
            --exclude integration_tests \
            --exclude stress_tests \
            --exclude examples \
            --exclude neumann_docs \
            --all-features \
            --no-run \
            --codecov --output-path codecov.json

      - name: Upload coverage HTML
        # v4.6.2
        uses: >-
          actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coverage-report
          path: target/llvm-cov/html

      - name: Upload to Codecov
        # v5.4.0
        uses: >-
          codecov/codecov-action@0565863a31f2c772f9f0395002a31e3f06189574
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: codecov.json
          fail_ci_if_error: false

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable

      - name: Cache Rust
        # v2.7.8
        uses: >-
          Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6

      - name: Install protoc
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y protobuf-compiler

      - name: Build docs
        run: >-
          cargo doc --workspace
          --exclude fuzz
          --exclude neumann-native
          --no-deps
        env:
          RUSTDOCFLAGS: -Dwarnings

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      checks: write
      contents: read
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Run audit
        # v2.0.0
        uses: >-
          rustsec/audit-check@dd51754d4e59da7395a4cd9b593f0ff2d61a9b95
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Run cargo-deny
        # v2
        uses: >-
          EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979
        with:
          command: check
          arguments: --all-features

  miri:
    name: Miri (undefined behavior)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # nightly
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: nightly
          components: miri

      - name: Setup Miri
        working-directory: tensor_store
        run: cargo miri setup

      - name: Run Miri on mmap module
        working-directory: tensor_store
        run: |
          cargo miri test mmap:: --lib

      - name: Run Miri on embedding_slab module
        working-directory: tensor_store
        run: |
          cargo miri test embedding_slab:: --lib

  typescript-sdk:
    name: TypeScript SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: >-
      needs.changes.outputs.typescript == 'true' ||
      github.event_name == 'push'
    defaults:
      run:
        working-directory: neumann-ts
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Node.js
        # v4.1.0
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: neumann-ts/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Lint
        run: npm run lint

      - name: Test with coverage (95% threshold enforced)
        run: |
          npm run coverage
          npx vitest run --coverage \
            --coverage.thresholds.lines=95 \
            --coverage.thresholds.functions=95 \
            --coverage.thresholds.statements=95 \
            --coverage.thresholds.branches=94

      - name: Upload coverage report
        # v4.6.2
        uses: >-
          actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coverage-typescript-sdk
          path: neumann-ts/coverage

  python-sdk:
    name: Python SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: >-
      needs.changes.outputs.python == 'true' ||
      github.event_name == 'push'
    defaults:
      run:
        working-directory: neumann-py
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Python
        # v5.6.0
        uses: >-
          actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: neumann-py/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint with ruff
        run: ruff check .

      - name: Format check with ruff
        run: ruff format --check .

      - name: Type check with mypy
        run: mypy src/neumann --strict

      - name: Test with coverage
        run: >-
          pytest
          --cov=neumann
          --cov-report=html
          --cov-report=term
          --cov-fail-under=95

      - name: Upload coverage report
        # v4.6.2
        uses: >-
          actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coverage-python-sdk
          path: neumann-py/htmlcov

  cross-platform:
    name: Cross-Platform
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust
        # stable
        uses: >-
          dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0
        with:
          toolchain: stable

      - name: Cache Rust
        # v2.7.8
        uses: >-
          Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6

      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y protobuf-compiler

      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        run: choco install protoc

      - name: Build workspace
        run: >-
          cargo build --workspace
          --exclude fuzz
          --exclude neumann-native

      - name: Test core crates
        run: |
          cargo test -p tensor_store
          cargo test -p relational_engine
          cargo test -p graph_engine
          cargo test -p vector_engine
          cargo test -p neumann_parser
          cargo test -p query_router

  docker:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up Docker Buildx
        # v3.10.0
        uses: >-
          docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2

      - name: Build CLI image
        # v6.15.0
        uses: >-
          docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4
        with:
          context: .
          target: cli
          push: false
          tags: neumann-cli:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Server image
        # v6.15.0
        uses: >-
          docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4
        with:
          context: .
          target: server
          push: false
          tags: neumann-server:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan CLI image for vulnerabilities
        # v0.30.0
        uses: >-
          aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5
        with:
          image-ref: neumann-cli:ci
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Scan Server image for vulnerabilities
        # v0.30.0
        uses: >-
          aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5
        with:
          image-ref: neumann-server:ci
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Calculate PR size
        id: size
        run: |
          BASE="origin/${{ github.base_ref }}"
          ADDS=$(git diff --numstat "$BASE...HEAD" | \
            awk '{sum += $1} END {print sum+0}')
          DELS=$(git diff --numstat "$BASE...HEAD" | \
            awk '{sum += $2} END {print sum+0}')
          TOTAL=$((ADDS + DELS))

          if [ "$TOTAL" -lt 10 ]; then
            LABEL="size/XS"
          elif [ "$TOTAL" -lt 100 ]; then
            LABEL="size/S"
          elif [ "$TOTAL" -lt 500 ]; then
            LABEL="size/M"
          elif [ "$TOTAL" -lt 1000 ]; then
            LABEL="size/L"
          elif [ "$TOTAL" -lt 2000 ]; then
            LABEL="size/XL"
          else
            LABEL="size/XXL"
          fi

          {
            echo "additions=$ADDS"
            echo "deletions=$DELS"
            echo "total=$TOTAL"
            echo "label=$LABEL"
          } >> "$GITHUB_OUTPUT"

      - name: Add size label
        # v7.0.1
        uses: >-
          actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const label = '${{ steps.size.outputs.label }}';

            const { data: labels } = await github.rest.issues
              .listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

            for (const existingLabel of labels) {
              if (existingLabel.name.startsWith('size/')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: existingLabel.name
                }).catch(() => {});
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

      - name: Comment on large PRs
        if: steps.size.outputs.total >= 1000
        # v7.0.1
        uses: >-
          actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const total = ${{ steps.size.outputs.total }};
            const adds = ${{ steps.size.outputs.additions }};
            const dels = ${{ steps.size.outputs.deletions }};

            const body = `## Large PR Warning

            This PR has **${total.toLocaleString()} lines** changed \
            (+${adds.toLocaleString()}/-${dels.toLocaleString()}).

            Large PRs are harder to review. Consider:
            - Breaking this into smaller, focused PRs
            - If AI-generated, review each change separately
            - Ensure tests cover all new code paths

            > Tip: Smaller PRs get reviewed faster.`;

            const { data: comments } = await github.rest.issues
              .listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

            const existing = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## Large PR Warning')
            );

            if (!existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  ci-success:
    name: CI Success
    needs:
      - fmt
      - check
      - clippy
      - test
      - coverage
      - doc
      - security-audit
      - cargo-deny
      - miri
      - cross-platform
      - typescript-sdk
      - python-sdk
      - docker
      - pr-size
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "Checking job results..."
          FAILED=false

          FMT="${{ needs.fmt.result }}"
          CHECK="${{ needs.check.result }}"
          CLIPPY="${{ needs.clippy.result }}"
          TEST="${{ needs.test.result }}"
          COV="${{ needs.coverage.result }}"
          DOC="${{ needs.doc.result }}"
          AUDIT="${{ needs.security-audit.result }}"
          DENY="${{ needs.cargo-deny.result }}"
          MIRI="${{ needs.miri.result }}"
          CROSS="${{ needs.cross-platform.result }}"
          DOCKER="${{ needs.docker.result }}"
          TS="${{ needs.typescript-sdk.result }}"
          PY="${{ needs.python-sdk.result }}"
          PR="${{ needs.pr-size.result }}"

          for job in fmt:$FMT check:$CHECK clippy:$CLIPPY \
                     test:$TEST coverage:$COV doc:$DOC \
                     security-audit:$AUDIT cargo-deny:$DENY \
                     miri:$MIRI cross-platform:$CROSS docker:$DOCKER; do
            name="${job%%:*}"
            result="${job##*:}"
            if [[ "$result" != "success" ]]; then
              echo "::error::$name failed: $result"
              FAILED=true
            fi
          done

          for job in typescript-sdk:$TS python-sdk:$PY pr-size:$PR; do
            name="${job%%:*}"
            result="${job##*:}"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "::error::$name failed: $result"
              FAILED=true
            fi
          done

          if [ "$FAILED" = true ]; then
            exit 1
          fi
          echo "All required jobs passed!"
