name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      typescript: ${{ steps.filter.outputs.typescript }}
      python: ${{ steps.filter.outputs.python }}
      rust: ${{ steps.filter.outputs.rust }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            typescript:
              - 'neumann-ts/**'
            python:
              - 'neumann-py/**'
            rust:
              - '**/*.rs'
              - '**/Cargo.toml'
              - 'Cargo.lock'

  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          components: rustfmt
      - run: cargo fmt --all --check

  check:
    name: Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - run: cargo check --workspace --exclude fuzz --exclude neumann-native --all-features

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          components: clippy
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - run: cargo clippy --workspace --exclude fuzz --exclude neumann-native --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - run: cargo test --workspace --exclude fuzz --exclude neumann-native --all-features

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@735e5933943122c5ac182670a935f54a949265c1 # v2.52.4
        with:
          tool: cargo-llvm-cov
      - name: Clean coverage artifacts
        run: cargo llvm-cov clean --workspace
      - name: Generate and verify coverage (95% threshold)
        run: |
          cargo llvm-cov --workspace \
            --exclude fuzz \
            --exclude neumann-native \
            --exclude integration_tests \
            --exclude stress_tests \
            --exclude examples \
            --exclude neumann_docs \
            --all-features \
            --fail-under-lines 95 \
            --html --output-dir target/llvm-cov/html
      - name: Generate codecov report
        run: |
          cargo llvm-cov --workspace \
            --exclude fuzz \
            --exclude neumann-native \
            --exclude integration_tests \
            --exclude stress_tests \
            --exclude examples \
            --exclude neumann_docs \
            --all-features \
            --no-run \
            --codecov --output-path codecov.json
      - name: Upload coverage HTML
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-report
          path: target/llvm-cov/html
      - name: Upload to Codecov
        uses: codecov/codecov-action@0565863a31f2c772f9f0395002a31e3f06189574 # v5.4.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: codecov.json
          fail_ci_if_error: false

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - name: Build docs
        run: cargo doc --workspace --exclude fuzz --exclude neumann-native --no-deps
        env:
          RUSTDOCFLAGS: -Dwarnings

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      checks: write
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: rustsec/audit-check@dd51754d4e59da7395a4cd9b593f0ff2d61a9b95 # v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979 # v2
        with:
          command: check
          arguments: --all-features

  miri:
    name: Miri (undefined behavior)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # nightly
        with:
          toolchain: nightly
          components: miri
      - name: Setup Miri
        working-directory: tensor_store
        run: cargo miri setup
      - name: Run Miri on mmap module
        working-directory: tensor_store
        run: |
          cargo miri test mmap:: --lib
      - name: Run Miri on embedding_slab module
        working-directory: tensor_store
        run: |
          cargo miri test embedding_slab:: --lib

  typescript-sdk:
    name: TypeScript SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.typescript == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: neumann-ts
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: neumann-ts/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Lint
        run: npm run lint
      - name: Test with coverage
        run: npm run coverage
      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-typescript-sdk
          path: neumann-ts/coverage

  python-sdk:
    name: Python SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: needs.changes.outputs.python == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: neumann-py
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: neumann-py/pyproject.toml
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Lint with ruff
        run: ruff check .
      - name: Format check with ruff
        run: ruff format --check .
      - name: Type check with mypy
        run: mypy src/neumann --strict
      - name: Test with coverage
        run: pytest --cov=neumann --cov-report=html --cov-report=term --cov-fail-under=95
      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-python-sdk
          path: neumann-py/htmlcov

  cross-platform:
    name: Cross-Platform
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf
      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        run: choco install protoc
      - name: Build workspace
        run: cargo build --workspace --exclude fuzz --exclude neumann-native
      - name: Test core crates
        run: |
          cargo test -p tensor_store
          cargo test -p relational_engine
          cargo test -p graph_engine
          cargo test -p vector_engine
          cargo test -p neumann_parser
          cargo test -p query_router

  docker:
    name: Docker Build & Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Build CLI image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          target: cli
          push: false
          tags: neumann-cli:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Server image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          target: server
          push: false
          tags: neumann-server:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan CLI image for vulnerabilities
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # v0.30.0
        with:
          image-ref: neumann-cli:ci
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

      - name: Scan Server image for vulnerabilities
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # v0.30.0
        with:
          image-ref: neumann-server:ci
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

  ci-success:
    name: CI Success
    needs: [fmt, check, clippy, test, coverage, doc, security-audit, cargo-deny, miri, cross-platform, typescript-sdk, python-sdk, docker]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          FAILED=false
          for job in fmt check clippy test coverage doc security-audit cargo-deny miri cross-platform docker; do
            result="${{ needs[job].result }}"
            if [[ "$result" != "success" ]]; then
              echo "::error::Job $job failed with result: $result"
              FAILED=true
            fi
          done
          # SDK jobs may be skipped via path filter
          for job in typescript-sdk python-sdk; do
            result="${{ needs[job].result }}"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "::error::Job $job failed with result: $result"
              FAILED=true
            fi
          done
          if [ "$FAILED" = true ]; then
            exit 1
          fi
          echo "All required jobs passed!"
