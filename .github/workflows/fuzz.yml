---
name: Fuzz

"on":
  schedule:
    - cron: '0 2 * * 0'  # Weekly Sunday 2am UTC

  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzz duration per target (seconds)'
        required: false
        default: '300'
      target:
        description: 'Specific target (or "all")'
        required: false
        default: 'all'

  pull_request:
    paths:
      - 'neumann_parser/**'
      - 'tensor_compress/**'
      - 'tensor_vault/**'
      - 'tensor_checkpoint/**'
      - 'tensor_store/**'
      - 'tensor_chain/**'
      - 'tensor_cache/**'
      - 'relational_engine/**'
      - 'vector_engine/**'
      - 'fuzz/**'

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  fuzz:
    name: Fuzz ${{ matrix.target }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        target:
          - parser_parse
          - parser_parse_all
          - parser_parse_expr
          - parser_tokenize
          - compress_ids
          - compress_rle
          - compress_snapshot
          - vault_cipher
          - checkpoint_state
          - storage_sparse_vector
          - slab_entity_index
          - consistent_hash
          - tcp_framing
          - membership
          - semantic_partition
          - consensus_merge
          - codebook_quantize
          - block_validate
          - distributed_tx_serialize
          - distributed_tx_coordinator
          - lock_manager
          - delta_quantize
          - raft_messages
          - relational_condition
          - relational_engine_ops
          - vector_engine_ops
          - cache_eviction_scorer
          - cache_semantic_search
          - cache_metric_roundtrip
          - cache_lifecycle
          - tt_roundtrip
          - streaming_format
          - delta_apply
          - raft_stateful_sequence
          - distributed_tx_sequence
          - hlc_ordering
          - membership_convergence
          - consensus_conflict

    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust nightly
        # nightly
        uses: >-
          dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: nightly
          components: llvm-tools-preview

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Restore corpus cache
        # v4.2.3
        uses: >-
          actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: >-
            fuzz-corpus-${{ matrix.target }}-${{
            hashFiles('fuzz/fuzz_targets/*.rs') }}-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-${{ matrix.target }}-

      - name: Set fuzz duration
        id: duration
        run: |
          EVENT="${{ github.event_name }}"
          INPUT="${{ github.event.inputs.duration }}"
          if [[ "$EVENT" == "pull_request" ]]; then
            echo "seconds=30" >> "$GITHUB_OUTPUT"
          elif [[ "$INPUT" != "" ]]; then
            echo "seconds=$INPUT" >> "$GITHUB_OUTPUT"
          else
            echo "seconds=600" >> "$GITHUB_OUTPUT"
          fi

      - name: Run fuzzer
        working-directory: fuzz
        run: |
          cargo +nightly fuzz run ${{ matrix.target }} \
            --sanitizer none \
            -- -max_total_time=${{ steps.duration.outputs.seconds }}

      - name: Check for crashes
        if: always()
        run: |
          ARTIFACT_DIR="fuzz/artifacts/${{ matrix.target }}"
          if [ -d "$ARTIFACT_DIR" ]; then
            CRASHES=$(find "$ARTIFACT_DIR" -type f 2>/dev/null | wc -l)
            if [ "$CRASHES" -gt 0 ]; then
              echo "::error::Found $CRASHES crash artifacts"
              ls -la "$ARTIFACT_DIR/"
              exit 1
            fi
          fi

      - name: Upload crash artifacts
        if: failure()
        # v4.6.2
        uses: >-
          actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: crashes-${{ matrix.target }}
          path: fuzz/artifacts/${{ matrix.target }}/
          if-no-files-found: ignore

      - name: Save corpus cache
        # v4.2.3
        uses: >-
          actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        if: always()
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: >-
            fuzz-corpus-${{ matrix.target }}-${{
            hashFiles('fuzz/fuzz_targets/*.rs') }}-${{ github.sha }}

      - name: Upload corpus
        # v4.6.2
        uses: >-
          actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: corpus-${{ matrix.target }}
          path: fuzz/corpus/${{ matrix.target }}/
          if-no-files-found: ignore

  fuzz-summary:
    name: Fuzz Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: fuzz
    if: always()

    steps:
      - name: Check fuzz results
        run: |
          if [[ "${{ needs.fuzz.result }}" != "success" ]]; then
            echo "::error::Fuzzing failed"
            exit 1
          fi
          echo "Fuzzing completed successfully for all targets"
