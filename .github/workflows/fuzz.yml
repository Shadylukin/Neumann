name: Fuzz

on:
  # Run on schedule (weekly Sunday 2am UTC)
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzz duration per target (seconds)'
        required: false
        default: '300'
      target:
        description: 'Specific target (or "all")'
        required: false
        default: 'all'

  # PR fuzzing for security-critical changes
  pull_request:
    paths:
      - 'neumann_parser/**'
      - 'tensor_compress/**'
      - 'tensor_vault/**'
      - 'tensor_checkpoint/**'
      - 'tensor_store/**'
      - 'tensor_chain/**'
      - 'tensor_cache/**'
      - 'relational_engine/**'
      - 'fuzz/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  fuzz:
    name: Fuzz ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          # Parser targets
          - parser_parse
          - parser_parse_all
          - parser_parse_expr
          - parser_tokenize
          # Compression targets
          - compress_ids
          - compress_rle
          - compress_snapshot
          # Crypto target
          - vault_cipher
          # Checkpoint target
          - checkpoint_state
          # Storage targets
          - storage_sparse_vector
          - slab_entity_index
          # Distributed targets
          - consistent_hash
          - tcp_framing
          - membership
          - semantic_partition
          - consensus_merge
          - codebook_quantize
          - block_validate
          - distributed_tx_serialize
          - distributed_tx_coordinator
          - lock_manager
          - delta_quantize
          - raft_messages
          # Relational engine targets
          - relational_condition
          - relational_engine_ops
          # Cache targets
          - cache_eviction_scorer
          - cache_semantic_search
          - cache_metric_roundtrip
          - cache_lifecycle
          # Tensor Train compression targets
          - tt_roundtrip
          - streaming_format
          - delta_apply

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Cache corpus
        uses: actions/cache@v4
        with:
          path: fuzz/corpus
          key: fuzz-corpus-${{ matrix.target }}-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-${{ matrix.target }}-
            fuzz-corpus-

      - name: Set fuzz duration
        id: duration
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "seconds=30" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.duration }}" != "" ]]; then
            echo "seconds=${{ github.event.inputs.duration }}" >> $GITHUB_OUTPUT
          else
            echo "seconds=600" >> $GITHUB_OUTPUT
          fi

      - name: Run fuzzer
        working-directory: fuzz
        run: |
          cargo +nightly fuzz run ${{ matrix.target }} \
            --sanitizer none \
            -- -max_total_time=${{ steps.duration.outputs.seconds }}
        continue-on-error: true

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crashes-${{ matrix.target }}
          path: fuzz/artifacts/${{ matrix.target }}/
          if-no-files-found: ignore

      - name: Upload corpus
        uses: actions/upload-artifact@v4
        with:
          name: corpus-${{ matrix.target }}
          path: fuzz/corpus/${{ matrix.target }}/
          if-no-files-found: ignore

  fuzz-summary:
    name: Fuzz Summary
    runs-on: ubuntu-latest
    needs: fuzz
    if: always()

    steps:
      - name: Check fuzz results
        run: |
          echo "Fuzzing completed for all targets"
          echo "Check individual job logs for any crashes found"
