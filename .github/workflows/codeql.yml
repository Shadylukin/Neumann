---
name: CodeQL

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * 0'  # Weekly on Sunday at 3am UTC

permissions:
  security-events: write
  contents: read

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript', 'python']

    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Initialize CodeQL
        # v3.28.18
        uses: >-
          github/codeql-action/init@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Setup Node.js
        if: matrix.language == 'javascript-typescript'
        # v4.1.0
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: '20'

      - name: Build TypeScript
        if: matrix.language == 'javascript-typescript'
        working-directory: neumann-ts
        run: |
          npm ci
          npm run build

      - name: Setup Python
        if: matrix.language == 'python'
        # v5.6.0
        uses: >-
          actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        if: matrix.language == 'python'
        working-directory: neumann-py
        run: |
          pip install -e ".[dev]"

      - name: Perform CodeQL Analysis
        # v3.28.18
        uses: >-
          github/codeql-action/analyze@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          category: "/language:${{ matrix.language }}"
