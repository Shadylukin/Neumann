#!/bin/bash
set -e

source "$HOME/.cargo/env" 2>/dev/null || true

REPO_ROOT="$(git rev-parse --show-toplevel)"
CRATES="tensor_store relational_engine graph_engine vector_engine query_router neumann_parser neumann_shell"
MINIMUM_COVERAGE=95

# Per-crate coverage thresholds (for crates with untestable interactive code)
get_min_coverage() {
    case "$1" in
        neumann_shell) echo 94 ;;  # Has ~40 lines of untestable interactive REPL code
        *) echo "$MINIMUM_COVERAGE" ;;
    esac
}

echo "Running pre-commit checks..."

for crate in $CRATES; do
    echo ""
    echo "=== Checking $crate ==="
    cd "$REPO_ROOT"

    echo "Formatting..."
    cargo fmt --package "$crate" --check

    echo "Clippy..."
    cargo clippy --package "$crate" -- -D warnings

    echo "Testing..."
    cargo test --package "$crate" --quiet

    echo "Docs..."
    cargo doc --package "$crate" --no-deps --quiet
done

# Coverage check (optional - can be slow)
if [ "${SKIP_COVERAGE:-0}" != "1" ]; then
    echo ""
    echo "=== Coverage Check ==="

    # Check if cargo-llvm-cov is installed
    if command -v cargo-llvm-cov &> /dev/null || cargo llvm-cov --version &> /dev/null 2>&1; then
        cd "$REPO_ROOT"
        for crate in $CRATES; do
            echo "Checking coverage for $crate..."

            # Get coverage percentage from the crate's own source file (not TOTAL which includes deps)
            # Field 10 is line coverage %. Match the specific crate's lib.rs (handles various path formats)
            COVERAGE=$(cargo llvm-cov --package "$crate" --quiet 2>&1 | grep -E "${crate}(/src)?/lib\.rs|^lib\.rs\s" | head -1 | awk '{print $10}' | tr -d '%')

            if [ -n "$COVERAGE" ]; then
                COVERAGE_INT=${COVERAGE%.*}
                CRATE_MIN=$(get_min_coverage "$crate")
                if [ "$COVERAGE_INT" -lt "$CRATE_MIN" ]; then
                    echo "ERROR: Coverage for $crate is ${COVERAGE}%, minimum required is ${CRATE_MIN}%"
                    exit 1
                fi
                echo "Coverage for $crate: ${COVERAGE}% (minimum: ${CRATE_MIN}%)"
            fi
        done
    else
        echo "Skipping coverage check (cargo-llvm-cov not installed)"
        echo "Install with: cargo install cargo-llvm-cov"
    fi
fi

echo ""
echo "All checks passed."
