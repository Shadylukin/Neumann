#!/bin/bash
set -e

source "$HOME/.cargo/env" 2>/dev/null || true

REPO_ROOT="$(git rev-parse --show-toplevel)"
CRATES="tensor_store relational_engine graph_engine vector_engine tensor_compress tensor_vault tensor_cache tensor_blob tensor_unified tensor_checkpoint query_router neumann_parser neumann_shell"
MINIMUM_COVERAGE=95

# Per-crate coverage thresholds
get_min_coverage() {
    case "$1" in
        neumann_shell) echo 88 ;;  # Has untestable REPL code and binary entry point
        neumann_parser) echo 91 ;;  # Complex parser with many edge cases
        tensor_blob) echo 91 ;;  # Async blob storage with complex I/O paths
        query_router) echo 92 ;;  # Large module with cross-engine integration, defensive error paths
        *) echo "$MINIMUM_COVERAGE" ;;
    esac
}

echo "Running pre-commit checks..."

for crate in $CRATES; do
    echo ""
    echo "=== Checking $crate ==="
    cd "$REPO_ROOT"

    echo "Formatting..."
    cargo fmt --package "$crate" --check

    echo "Clippy..."
    cargo clippy --package "$crate" -- -D warnings

    echo "Testing..."
    cargo test --package "$crate" --quiet

    echo "Docs..."
    cargo doc --package "$crate" --no-deps --quiet
done

# Coverage check (optional - can be slow)
if [ "${SKIP_COVERAGE:-0}" != "1" ]; then
    echo ""
    echo "=== Coverage Check ==="

    # Check if cargo-llvm-cov is installed
    if command -v cargo-llvm-cov &> /dev/null || cargo llvm-cov --version &> /dev/null 2>&1; then
        cd "$REPO_ROOT"
        for crate in $CRATES; do
            echo "Checking coverage for $crate..."

            # Get coverage output
            COV_OUTPUT=$(cargo llvm-cov --package "$crate" --summary-only 2>&1)

            # Extract lines for this crate's files only (excluding dependencies)
            # Coverage output formats vary:
            # - "crate_name/src/file.rs" - relative path with crate prefix
            # - "file.rs" - standalone filename (main crate files when no path prefix)
            # - "/abs/path/crate_name/src/file.rs" - absolute path
            # Dependencies always appear with their own crate path prefix.
            #
            # Strategy: Match lines that either:
            # 1. Start with the crate name followed by /
            # 2. Start with just a .rs filename (no / before the extension)
            # 3. Contain /crate_name/src/ in the path
            TOTAL_LINES=$(echo "$COV_OUTPUT" | awk -v crate="$crate" '
                # Skip header, separator, and total lines
                /^Filename|^----|^TOTAL/ { next }

                # Match: crate_name/src/file.rs (starts with crate name)
                $1 ~ "^"crate"/" { lines += $8; missed += $9; next }

                # Match: /some/path/crate_name/src/file.rs (contains crate in path)
                $1 ~ "/"crate"/src/" { lines += $8; missed += $9; next }

                # Match: file.rs (standalone filename - no slash, ends in .rs)
                # These are main crate files when cargo-llvm-cov omits the path
                $1 ~ /^[a-z_]+\.rs$/ { lines += $8; missed += $9; next }

                END { print (lines ? lines : 0), (missed ? missed : 0) }
            ')
            LINES=$(echo "$TOTAL_LINES" | awk '{print $1}')
            MISSED=$(echo "$TOTAL_LINES" | awk '{print $2}')

            if [ -z "$LINES" ] || [ "$LINES" -eq 0 ]; then
                echo "ERROR: No coverage data found for $crate"
                echo "This may indicate a bug in the coverage pattern matching."
                exit 1
            fi

            COVERED=$((LINES - MISSED))
            COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($COVERED / $LINES) * 100}")
            COVERAGE_INT=${COVERAGE%.*}
            CRATE_MIN=$(get_min_coverage "$crate")
            if [ "$COVERAGE_INT" -lt "$CRATE_MIN" ]; then
                echo "ERROR: Coverage for $crate is ${COVERAGE}%, minimum required is ${CRATE_MIN}%"
                exit 1
            fi
            echo "Coverage for $crate: ${COVERAGE}% (minimum: ${CRATE_MIN}%)"
        done
    else
        echo "Skipping coverage check (cargo-llvm-cov not installed)"
        echo "Install with: cargo install cargo-llvm-cov"
    fi
fi

echo ""
echo "All checks passed."
