# Cargo-deny configuration for Neumann
# Strict dependency hygiene for infrastructure code

[graph]
all-features = false
no-default-features = false

[output]
feature-depth = 1

# =============================================================================
# ADVISORIES - Security vulnerability checks
# =============================================================================
[advisories]
# Deny yanked crates
yanked = "deny"
# Unmaintained crates in transitive deps are outside our control
unmaintained = "none"
ignore = []

# =============================================================================
# LICENSES - Only allow approved open source licenses
# =============================================================================
[licenses]
allow = [
    "MIT",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "ISC",
    "Zlib",
    "Unicode-3.0",
    "BSL-1.0",
    "CC0-1.0",
    "OpenSSL",
]
confidence-threshold = 0.8
exceptions = []

[licenses.private]
# Ignore license checks for unpublished workspace crates
ignore = true
registries = []

# =============================================================================
# BANS - Dependency restrictions and duplicate detection
# =============================================================================
[bans]
# STRICT: Deny multiple versions of the same crate
multiple-versions = "deny"
# Allow wildcards for workspace path dependencies (standard practice)
wildcards = "allow"
highlight = "all"
workspace-default-features = "allow"
external-default-features = "allow"
allow = []
deny = []

# -----------------------------------------------------------------------------
# SKIP: Documented exceptions for unavoidable transitive dependency conflicts
# Each entry explains WHY the duplicate exists and which crates cause it.
# These should be reviewed periodically to see if upstream has aligned.
# -----------------------------------------------------------------------------
skip = [
    # --- Encoding ---
    { crate = "base64@0.21", reason = "tiktoken-rs requires 0.21, tonic requires 0.22" },

    # --- Concurrency ---
    { crate = "dashmap@5", reason = "tensor_chain uses 5.x, opentelemetry uses 6.x" },

    # --- Crypto/Random ---
    { crate = "getrandom@0.2", reason = "crypto crates use 0.2, uuid uses 0.3" },

    # --- Collections ---
    { crate = "hashbrown@0.14", reason = "dashmap 5.x requires 0.14" },
    { crate = "hashbrown@0.15", reason = "petgraph (via prost-build) uses 0.15, other crates use 0.16" },
    { crate = "rustc-hash@1", reason = "tiktoken-rs uses 1.x, tensor_store uses 2.x" },

    # --- String/Text ---
    { crate = "heck@0.4", reason = "tabled_derive uses 0.4, clap_derive uses 0.5" },

    # --- Proc macros ---
    { crate = "syn@1", reason = "older proc-macro crates require syn 1.x" },

    # --- Error handling ---
    { crate = "thiserror@1", reason = "x509-parser/opentelemetry use 1.x, we use 2.x" },
    { crate = "thiserror-impl@1", reason = "thiserror 1.x requires thiserror-impl 1.x" },

    # --- Random ---
    { crate = "rand@0.8", reason = "proptest/tiktoken-rs use 0.8, opentelemetry uses 0.9" },
    { crate = "rand_chacha@0.3", reason = "rand 0.8 requires rand_chacha 0.3" },
    { crate = "rand_core@0.6", reason = "rand 0.8 requires rand_core 0.6" },

    # --- Networking ---
    { crate = "socket2@0.5", reason = "tensor_chain/tonic use 0.5, tokio uses 0.6" },
]

# -----------------------------------------------------------------------------
# SKIP-TREE: Skip entire dependency trees for platform-specific crates
# Windows platform crates have extreme version fragmentation across the ecosystem
# -----------------------------------------------------------------------------
skip-tree = [
    { crate = "windows-sys", reason = "Windows FFI bindings fragment across ring/tokio/socket2/clap versions" },
    { crate = "windows-targets", reason = "Windows platform targets fragment with windows-sys" },
]

# =============================================================================
# SOURCES - Only allow crates from trusted sources
# =============================================================================
[sources]
# STRICT: Deny crates from unknown registries or git repos
unknown-registry = "deny"
unknown-git = "deny"
# Only allow crates.io
allow-registry = ["https://github.com/rust-lang/crates.io-index"]
allow-git = []

[sources.allow-org]
github = []
gitlab = []
bitbucket = []
